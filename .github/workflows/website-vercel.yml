name: Website Deploy (Vercel)

on:
  push:
    branches:
      - main
    paths:
      - 'website/**'
      - 'Cargo.toml'
      - 'install.sh'
      - '.github/workflows/website-vercel.yml'
  workflow_dispatch:

permissions:
  contents: read

jobs:
  deploy:
    name: Deploy website to Vercel
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
          cache-dependency-path: website/package-lock.json

      - name: Resolve Mato version from Cargo.toml
        id: version
        shell: bash
        run: |
          set -euo pipefail
          VERSION=$(sed -n 's/^version = "\(.*\)"/\1/p' Cargo.toml | head -n1)
          if [ -z "$VERSION" ]; then
            echo "Failed to parse version from Cargo.toml"
            exit 1
          fi
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"

      - name: Install website dependencies
        working-directory: website
        run: npm ci

      - name: Install Vercel CLI
        run: npm install --global vercel@latest

      - name: Pull Vercel project settings
        working-directory: website
        run: vercel pull --yes --environment=production --token="${{ secrets.VERCEL_TOKEN }}"
        env:
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

      - name: Build website
        working-directory: website
        run: vercel build --prod --token="${{ secrets.VERCEL_TOKEN }}" --build-env MATO_VERSION=${{ steps.version.outputs.version }}
        env:
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
          MATO_VERSION: ${{ steps.version.outputs.version }}

      - name: Deploy website
        working-directory: website
        run: vercel deploy --prebuilt --prod --token="${{ secrets.VERCEL_TOKEN }}" --build-env MATO_VERSION=${{ steps.version.outputs.version }} --env MATO_VERSION=${{ steps.version.outputs.version }}
        env:
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
